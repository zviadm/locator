<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Marauder's Map</title>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

        <script type="text/javascript">
            // Database? who needs one when you can define everything as global constants...
            var DEVICE_TO_NAME = {
                "c8aa21b053c3" : "zviad",
            };
            var SCALE = 1.0;

            var device_locations = {};
            var current_locations = {};
            var current_steps = {}

            var LOCATION_UPDATE_RATE = 1000.0;
            var ANIMATION_UPDATE_RATE = 40.0;

            function update_locations() {
                var xmlhttp = new XMLHttpRequest();
                var body = JSON.stringify({
                        "method" : "get_locations",
                        });

                xmlhttp.open("POST", "/rpc", true);
                xmlhttp.setRequestHeader("Content-type", "application/json");

                xmlhttp.onreadystatechange = function() {
                    if(xmlhttp.readyState == 4) {
                        if (xmlhttp.status == 200) {
                            var ret = JSON.parse(xmlhttp.responseText);
                            for (var device in ret["locations"]) {
                                var loc_x = Math.floor(ret["locations"][device][0] * SCALE);
                                var loc_y = Math.floor(ret["locations"][device][1] * SCALE);
                                var device = device.replace(/\:/g, "");

                                if (!(device in device_locations)) {
                                    $("#devices").append(
                                            '<div id="' + device + '" style="position:absolute;left:-1000px;top:-1000px">' +
                                            '<img src="/static/images/' + DEVICE_TO_NAME[device] + '.jpg" /></div>'
                                            );
                                    current_locations[device] = [loc_x, loc_y];
                                    current_steps[device] = 0;
                                } else {
                                    current_steps[device] = LOCATION_UPDATE_RATE / ANIMATION_UPDATE_RATE;
                                }
                                device_locations[device] = [loc_x, loc_y];
                            }
                        } else if (xmlhttp.status != 0) {
                            // TODO(zm): if 502 or 503, should probably retry after some time
                        }
                        setTimeout('update_locations()', LOCATION_UPDATE_RATE);
                    }
                }
                xmlhttp.send(body);
            }

            function animate_locations() {
                for (var device in current_locations) {
                    if (current_steps[device] <= 0) {
                        current_locations[device] = device_locations[device];
                    } else {
                        var x_delta = device_locations[device][0] - current_locations[device][0];
                        var y_delta = device_locations[device][1] - current_locations[device][1];

                        current_locations[device][0] += x_delta / current_steps[device];
                        current_locations[device][1] += y_delta / current_steps[device];
                        current_steps[device]--;
                    }
                    var loc_x = Math.floor(current_locations[device][0] * SCALE) + "px";
                    var loc_y = Math.floor(current_locations[device][1] * SCALE) + "px";

                    $("#" + device).css('left', loc_x);
                    $("#" + device).css('top',  loc_y);
                }
            }

            function point_it(event){
                pos_x = event.offsetX?(event.offsetX):event.pageX-document.getElementById("map").offsetLeft;
                pos_y = event.offsetY?(event.offsetY):event.pageY-document.getElementById("map").offsetTop;
                document.getElementById("click_xy").value = pos_x + ", " + pos_y;
                document.getElementById("click_xy").style.left = pos_x + "px";
                document.getElementById("click_xy").style.top = pos_y + "px";
                document.getElementById("click_xy").focus();
                document.getElementById("click_xy").select();
            }

            $(document).ready(function() {
                setTimeout('update_locations()', LOCATION_UPDATE_RATE);
                setInterval('animate_locations()', ANIMATION_UPDATE_RATE);
            });
        </script>
    </head>
    <body>
        <!-- <h1 align="center">t..nt t..nt tntttt t.t t..t t.....</h1> -->
        <div style="position:relative;width:100%;height:100%">
            <div id="map" style="position:absolute;top:0;left:0;width:100%;height:100%" onclick="point_it(event)">
                <img src="/static/images/awesomemap.png" />
            </div>
            <div id="devices" style="position:relative;top:0;left:0;width:100%;height:100%"></div>
            <input type="text" id="click_xy" size="8" style="position:absolute;top-10000px;left:-10000px;" />
        </div>

    </body>
</html>
